<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Labeling System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>

  <body
    class="bg-gray-100 min-h-screen flex flex-col items-center justify-center py-10 relative"
  >
    <h1 class="text-3xl font-bold text-gray-800 mb-8">Image Labeling System</h1>

    <!-- Skip Button -->
    <button
      id="skipImage"
      class="absolute z-10 px-6 py-2 bg-yellow-600 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-700 focus:outline-none transition duration-300 top-0 right-1/2 transform translate-x-1/2"
    >
      Skip Image
    </button>

    <div class="absolute left-0 top-0 mt-12 ml-8 w-48 bg-white p-4 rounded-lg shadow-md">
      <h3 class="text-lg font-semibold mb-2">Shortcuts</h3>
      <ul class="text-sm">
        <li><span class="font-bold">A</span> - Attic</li>
        <li><span class="font-bold">E</span> - Exterior</li>
        <li><span class="font-bold">K</span> - Kitchen</li>
        <li><span class="font-bold">L</span> - Living Room</li>
        <li><span class="font-bold">G</span> - Garage</li>
        <li><span class="font-bold">O</span> - Other</li>
        <li><span class="font-bold">1</span> - Bedroom</li>
        <li><span class="font-bold">2</span> - Bathroom</li>
        <li><span class="font-bold">3</span> - Basement</li>
      </ul>
    </div>

    <div id="imageContainer" class="relative w-96 h-64 mt-12">
      <img
        id="image"
        src=""
        alt="Image will appear here"
        class="w-full h-full object-cover rounded-lg shadow-lg hidden"
      />
    </div>

    <div id="labelContainer" class="mt-4 hidden">
      <h3 class="text-lg font-medium text-gray-700 mb-4 text-center">
        Select a Label for the Image
      </h3>
      <form id="labelForm" class="flex flex-col space-y-4 items-center">
        <select
          id="labelSelect"
          class="w-full max-w-xs px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
          <option value="Exterior">Exterior</option>
          <option value="Bathroom">Bathroom</option>
          <option value="Bedroom">Bedroom</option>
          <option value="Kitchen">Kitchen</option>
          <option value="Living Room">Living Room</option>
          <option value="Basement">Basement</option>
          <option value="Attic">Attic</option>
          <option value="Garage">Garage</option>
          <option value="Other">Other</option>
        </select>

        <button
          type="submit"
          class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none transition duration-300"
        >
          Submit Label
        </button>
      </form>
    </div>

    <script>
      let imageId;
      let currentSessionId;

      // Axios interceptor for logging all requests and responses
      axios.interceptors.request.use((request) => {
        console.log("Starting Request", request);
        return request;
      });
      axios.interceptors.response.use((response) => {
        console.log("Response:", response);
        return response;
      });

      async function fetchSessionId() {
        try {
          const response = await axios.get("/get_session_id");
          currentSessionId = response.data.session_id;
          console.log("Fetched session_id:", currentSessionId);
          return currentSessionId;
        } catch (error) {
          console.error("Error fetching session ID:", error);
          return null;
        }
      }

      // Function to fetch an image
      function fetchImage() {
        axios
          .get("/get_image")
          .then((response) => {
            if (response.data.success) {
              const imageData = response.data.image;
              imageId = imageData.id;

              const imgElement = document.getElementById("image");
              imgElement.src = imageData.url;
              imgElement.classList.remove("hidden");
              document.getElementById("labelContainer").classList.remove("hidden");

              console.log("Fetched image with ID:", imageId);
            } else {
              console.error("No images available:", response.data.message);
              alert("No more images to label");
            }
          })
          .catch((error) => {
            console.error("Error fetching image:", error);
            alert("Error fetching image. Please try again.");
          });
      }

      // Function to skip the current image
      function skipImage() {
        if (!imageId || !currentSessionId) {
          console.error("Image ID or Session ID is missing. Cannot skip.");
          alert("Image or session ID is missing. Please reload the page.");
          return;
        }

        axios
          .post("/skip_image", { image_id: imageId, session_id: currentSessionId })
          .then((response) => {
            if (response.data.success) {
              console.log("Image skipped successfully");
              fetchImage();
            } else {
              console.error("Error skipping image:", response.data.message);
              alert("Error skipping image. Please try again.");
            }
          })
          .catch((error) => {
            console.error("Error skipping image:", error);
            alert("Error skipping image. Please try again.");
          });
      }

      document.getElementById("skipImage").addEventListener("click", skipImage);

      document
        .getElementById("labelForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          if (!imageId) {
            alert("No image loaded. Please fetch an image first.");
            return;
          }

          if (!currentSessionId) {
            currentSessionId = await fetchSessionId();
          }

          if (!currentSessionId) {
            alert("No session ID found. Please log in again.");
            return;
          }

          const selectedLabel = document.getElementById("labelSelect").value;

          axios
            .post("/update_label", {
              image_path: imageId,
              label: selectedLabel,
              user_id: currentSessionId,
            })
            .then((response) => {
              if (response.data.success) {
                console.log("Label submitted successfully");
                fetchImage();
              } else {
                alert("Error submitting label: " + response.data.message);
              }
            })
            .catch((error) => {
              console.error("Error submitting label:", error);
              alert("Error submitting label. Please try again.");
            });
        });

      // Add keyboard shortcuts for form submission
      const keyLabelMap = {
        a: "Attic",
        e: "Exterior",
        k: "Kitchen",
        l: "Living Room",
        g: "Garage",
        o: "Other",
        1: "Bedroom",
        2: "Bathroom",
        3: "Basement",
      };

      document.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          document.getElementById("labelForm").dispatchEvent(new Event("submit"));
        }
        const label = keyLabelMap[event.key.toLowerCase()];
        if (label) {
          event.preventDefault();
          document.getElementById("labelSelect").value = label;
          document.getElementById("labelForm").dispatchEvent(new Event("submit"));
        }
      });

      // Fetch session ID and image when page loads
      fetchSessionId().then(() => fetchImage());
    </script>
  </body>
</html>
